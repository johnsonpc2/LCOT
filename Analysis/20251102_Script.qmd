---
title: "Learning Contingencies Over Time"
author: "Pierce C. Johnson"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

# Setup

First I setup the environment and save information about my data files. I'll
also load in data and save it into a single data.table.

```{r}
#| label: Setup and Data Processing
#| echo: true
#| message: false
#| warning: false

# Clear console and plot viewer
cat("\014")
graphics.off()
rm(list = ls(all.names = TRUE))

# Load packages
c("beepr", "data.table", "emmeans", "ggplot2",
  "ggdist", "here", "lme4", "lmerTest", "pcjtools") |>
  purrr::map(.f = library, character.only = T) |>
  invisible()

# Store the working directory
wd <- here()

# Store info about the data files
files_info(path = paste0(wd, "/data")) -> files

# Read all the data files in
lapply(
  X = files$filepath,
  FUN = fread
) -> data_list

# And bind them all into a single data.table
rbindlist(data_list, fill = TRUE) -> dt

# Count the number of subjects whose data we've collected
length(table(dt$sona_id)) -> n_subjects_initial

# Subset data
cols_to_keep <- c("trial_index", "sona_id", "phase",
                  "rt", "stimulus", "response", "block",
                  "contingency", "intact_first", "pair_type")

dt[, ..cols_to_keep] -> dt_sub

# Process data
dt_sub[(phase == "memory_trial_pair_1" |
          phase == "memory_trial_pair_2") &
          rt != "null",
       ][, `:=`(
         # Re-format the RTs to seconds
         rt = as.numeric(rt) / 1000,
         # Quantify a confidence metric
         confidence = fcase(
           intact_first == TRUE,
           1 - (as.numeric(response)) / 100,
           intact_first == FALSE,
           (as.numeric(response)) / 100,
           default = NA
         ),
         contingency = factor(
           contingency,
           levels = c("100", "75", "50")
           )
         )
       ][, `:=`(
         # Compute the average confidence
         avg_confidence = mean(confidence, na.rm = TRUE),
         # Compute the average RT of each subject
         avg_rt = mean(rt, na.rm = TRUE),
         med_rt = median(rt, na.rm = TRUE)
       ), by = list(sona_id, block)
       ][(med_rt < 15 & avg_rt < 15) & avg_confidence > 0.5,
       ] -> dt_results

# Finally, count the number of subjects retained after exclusion
length(table(dt_results$sona_id)) -> n_subjects_retained
```

Initially, we've collected data from `r as.character(n_subjects_initial)`
subjects. After exclusions, we retain data from
`r as.character(n_subjects_retained)` participants
(`r as.character(round((n_subjects_retained / n_subjects_initial) * 100), 2)`%)
who had med response times \< 10 seconds, mean RTs under 17 seconds, and had an
average confidence in their ratings \> 0.5.

Now plot the average confidence rating for each contingency condition across the
three learning and test blocks:

```{r}
#| label: Confidence Over Time
#| echo: false
#| message: false
#| warning: false

# Block on x-axis, contingency as separate lines
ggplot(
  data = dt_results,
  mapping = aes(
    x = factor(block),
    y = confidence,
    color = factor(contingency),
    group = factor(contingency)
    )
  ) +
  scale_x_discrete(breaks = seq(1, 3, by = 1)) +
  scale_y_continuous(limits = c(0, 1)) +
  stat_summary(
    fun.data = mean_cl_boot,
    mapping = aes(
      shape = factor(
        x = dt_results$contingency,
        levels = c("100", "75", "50"),
        labels = c("100%", "75%", "50%"))
    ),
    geom = "pointrange",
    alpha = .5
    ) +
  stat_summary(
    fun = mean,
    geom = "line",
    alpha = .5
    ) +
  guides(color = "none") +
  labs(
    shape = "Contingency",
    y = "Confidence",
    x = "Block"
  ) +
  theme(
    legend.position = c(.5, .90),
    legend.direction = "horizontal",
    legend.background = element_rect(fill = "white")
    ) -> learning_by_block

print(learning_by_block)
```

```{r}
# Ridge plot of confidence by subject, colored by block
ggplot(
  data = dt_results,
  mapping = aes(
    x = factor(block),
    y = confidence,
    fill = factor(contingency, labels = c("100%", "75%", "50%")),
    group = contingency
  )
) +
  stat_halfeye(point_interval = "mean_qi",
               fill_type = "segments", alpha = 0.5) +
  stat_summary(
    fun = mean,
    geom = "line",
    alpha = 0.6,
    linewidth = 1
  ) +
  facet_wrap(facets = "contingency") +
  geom_hline(
    yintercept = 0.5,
    linetype = "dashed",
    color = "red",
    alpha = .4,
    lwd = 1.5
  ) +
  theme(
    panel.border = element_rect(
      color = "black",
      fill = NA,
      linewidth = 2),
    panel.background = element_rect(
      fill = "white"
    ),
    strip.background = element_blank(),
    strip.text = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal"
  ) +
  labs(
    fill = "Contingency:",
    y = "Confidence",
    x = "Test Point"
  )
```

```{r}
# Calculate difference from 50% baseline for each subject and block
dt_results[, .(
  confidence = mean(confidence, na.rm = TRUE)
), by = .(sona_id, block, contingency)
][, baseline_50 := confidence[contingency == "50"], 
  by = .(sona_id, block)
][, confidence_diff := confidence - baseline_50
] -> dt_diff

# Now plot the differences
ggplot(
  data = dt_diff[contingency != "50"],
  mapping = aes(
    x = factor(block),
    y = confidence_diff,
    fill = factor(contingency, labels = c("100%", "75%")),
    group = contingency
  )
) +
  stat_halfeye(point_interval = "mean_qi",
               fill_type = "segments", alpha = 0.5) +
  stat_summary(
    fun = mean,
    geom = "line",
    alpha = 0.6,
    linewidth = 1
  ) +
  facet_wrap(facets = "contingency") +
  geom_hline(
    yintercept = 0,  # Changed to 0 since we're plotting differences
    linetype = "dashed",
    color = "red",
    alpha = .4,
    lwd = 1.5
  ) +
  theme(
    panel.border = element_rect(
      color = "black",
      fill = NA,
      linewidth = 2),
    panel.background = element_rect(
      fill = "white"
    ),
    strip.background = element_blank(),
    strip.text = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal"
  ) +
  labs(
    fill = "Contingency:",
    y = "Confidence (Difference from 50% Baseline)",
    x = "Test Point"
  )
```

```{r}
#| label: Significance Test in the Difference from 50

# Mixed model with random intercept for subject
lmm <- lmer(confidence_diff ~ contingency * block + (1|sona_id), 
            data = dt_diff[contingency != "50"])
anova(lmm)
summary(lmm)
```
