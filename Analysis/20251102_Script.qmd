---
title: "Learning Contingencies Over Time"
author: "Pierce C. Johnson"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## Quarto

Quarto enables you to weave together content and executable code into a finished
document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes
both content and the output of embedded code. You can embed code like this:

```{r}
#| label: Setup
#| message: false
#| warning: false

# Clear console
  cat("\014")
# Clear graphs, and remove objects from the environment
  graphics.off()
  rm(list = ls(all.names = TRUE))

# Get working directory
  wd <- dirname(getwd())

# Name the packages you need to load
  c("beepr", "data.table",
    "ggplot2", "pcjtools") |>

# Load above packages with purrr
  purrr::map(
    .f = library,
    character.only = T) |>
    invisible()
```

You can add options to executable code like this

```{r}
#| label: Read In Data
#| echo: false
#| message: false
#| warning: false

files_info(path = paste0(wd, "/LCOT/data")) -> files


sapply(
  X = files$filepath,
  FUN = fread
  ) -> data_list

rbindlist(data_list, fill = TRUE) -> dt
```

```{r}

# Subset your data to the columns you need for analysis of the learning data
dt[, .(trial_index, sona_id, phase, rt,
       stimulus, response, block, contingency,
       intact_first, pair_type)] -> dt_sub

length(table(dt$sona_id)) -> n_subjects_initial

# Now subset to the rows of the data you need
dt_sub[(phase == "memory_trial_pair_1" | 
         phase == "memory_trial_pair_2") & 
         rt != "null",
       ][, confidence := fcase(
         intact_first == TRUE,
         1 - (as.numeric(response)) / 100,
         intact_first == FALSE,
         (as.numeric(response)) / 100,
         default = NA
         )
         ][, `:=`(
           rt = as.numeric(rt) / 1000,
           avg_confidence = mean(confidence, na.rm = TRUE),
           p_value = t.test(
             x = confidence,
             mu = 0.5,
             alternative = "greater")$p.value,
           avg_rt = mean(as.numeric(rt)) / 1000
           ), by = sona_id
           ][avg_rt < 20, 
             ] -> dt_results

# Exclusion criteria for chance performance: (p_value < 0.05 & avg_confidence > 0.50 )

length(table(dt_results$sona_id)) -> n_subjects_retained

# Block on x-axis, contingency as separate lines
ggplot(
  data = dt_results,
  mapping = aes(
    x = factor(block),
    y = confidence,
    color = factor(contingency),
    group = factor(contingency)
    )
  ) +
  scale_x_discrete(breaks = seq(1, 3, by = 1)) +
  stat_summary(
    fun.data = mean_cl_boot,
    mapping = aes(
      shape = factor(dt_results$contingency)
    ),
    geom = "pointrange",
    alpha = .5
    ) +
  stat_summary(
    fun = mean,
    geom = "line",
    alpha = .5
    ) -> learning_by_block
```
